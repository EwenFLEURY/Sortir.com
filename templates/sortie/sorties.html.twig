{% extends 'base.html.twig' %}

{% block stylesheets %}
    {{ parent() }}

    <link rel="stylesheet" href="{{ asset('styles/tableau.css') }}">
{% endblock %}

{% block body %}
    <div name="filter" class="mt-2">
        <div class="container">
            <h3>Filtrer les sorties</h3>
            <div class="row">
                <div class="col">
                    <label for="site-filter" class="mr-2">Filtrer par site :</label>
                    <select id="site-filter" class="form-select" style="max-width: 340px;">
                        <option value="">— Tous les sites —</option>
                        {% for site in sites %}
                            <option value="{{ site.id }}">{{ site.nom }}</option>
                        {% endfor %}
                    </select>
                    <label for="nom-filter" class="mr-2">Filtrer par nom :</label>
                    <input type="text" id="nom-filter" class="form-control" placeholder="Tapez un nom de sortie..." style="max-width: 340px;">
                    <div class="row mt-2">
                        <div class="col">
                            <label for="date-debut-filter" class="mr-2">Date de début  :</label>
                            <input type="date" id="date-debut-filter" class="form-control" style="max-width: 200px;">
                        </div>
                        <div class="col">
                            <label for="date-fin-filter" class="mr-2">Date de fin  :</label>
                            <input type="date" id="date-fin-filter" class="form-control" style="max-width: 200px;">
                        </div>
                    </div>
                </div>
                <div class="col">

                {% if app.user %}
                    <div class="row mt-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="organisateur-filter">
                            <label class="form-check-label" for="organisateur-filter">
                                Sorties dont je suis l'organisateur
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="inscrit-filter">
                            <label class="form-check-label" for="inscrit-filter">
                                Sorties dont je suis inscrit
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="pas-inscrit-filter">
                            <label class="form-check-label" for="pas-inscrit-filter">
                                Sorties dont je ne suis pas inscrit
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="passee-filter">
                            <label class="form-check-label" for="passee-filter">
                                Sorties passées
                            </label>
                        </div>
                    </div>
                {% endif %}
                </div>
                <div class="col d-flex justify-content-center align-items-center">
                    <button type="button" id="reset-filters" class="btn btn-outline-secondary">Réinitialiser les filtres</button>
                </div>
            </div>
        </div>
    </div>

    <div name="list" class="mt-2">
        <div class="container">
            {% if sorties %}
                <div class="table-container table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                        <tr>
                            <th>Nom de la sortie</th>
                            <th>Date de la sortie</th>
                            <th>Fin de la sortie </th>
                            <th>Cloture inscription </th>
                            <th>Inscrits/places</th>
                            <th>Etat</th>
                            <th>Inscrit</th>
                            <th>Organisateur</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="sorties-list">
                            {% for sortie in sorties %}
                                {% set fin = sortie.dateHeureDebut|date_modify('+' ~ sortie.duree ~ ' minutes') %}

                                {% if sortie.dateheureDebut > date('-1 month') %}
                                    <tr data-site-id="{{ sortie.site ? sortie.site.id : '' }}"
                                        data-sortie-name="{{ sortie.nom ? sortie.nom|lower : '—' }}"
                                        data-date="{{ sortie.dateHeureDebut|date('Y-m-d') }}"
                                        data-organisateur="{{ app.user and app.user.nom == sortie.organisateur.nom ? 'true' : 'false' }}"
                                        data-inscrit="{{ app.user and app.user in sortie.participants ? 'true' : 'false' }}"
                                        data-passee="{{ (fin|date('U')) < ('now'|date('U')) ? 'true' : 'false' }}">
                                        <td>{{ sortie.nom }}</td>
                                        <td>{{ sortie.dateHeureDebut|date('d/m/Y H:i') }}</td>
                                        <td>{{ fin|date('d/m/Y H:i') }}</td>
                                        <td>{{ sortie.dateLimiteInscription|date('d/m/Y H:i') }}</td>
                                        <td>{{ sortie.participants|length }}/ {{ sortie.nbInscriptionMax }}</td>
                                        <td>{{ sortie.etat.value }}</td>
                                        <td>
                                            {% if app.user %}
                                                {% if app.user in sortie.participants %}
                                                    <i class="bi bi-check-circle-fill text-success text-center"></i>
                                                {% else %}
                                                {% endif %}
                                            {% else %}
                                                Pas d'utilisateur connectées
                                            {% endif %}
                                        </td>
                                        <td>{{ sortie.organisateur.nom }}</td>
                                        <td>
                                            {% if app.user %}
                                                {% if app.user.nom == sortie.organisateur.nom  %}
                                                    {% if sortie.etat.value ==  "Créée" %}
                                                        <a class="btn btn-outline-secondary" href="#" role="button">Modifier</a>
                                                        <a class="btn btn-outline-secondary" href="#" role="button">Publier</a>
                                                    {% else %}
                                                        {% if sortie.etat.value ==  "Ouverte" %}
                                                            <a class="btn btn-outline-secondary" href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>
                                                            <a class="btn btn-outline-secondary" href="{{ url('sorties_cancel',{'id': sortie.id}) }}" role="button">Annuler</a>
                                                        {% endif %}
                                                    {% endif %}
                                                    {% if sortie.etat.value ==  "Annulée"   %}
                                                        <a class="btn btn-outline-secondary"href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>
                                                    {% endif %}
                                                    {% if sortie.etat.value ==  "Passée"  %}
                                                        <a class="btn btn-outline-secondary" href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>
                                                    {% endif %}
                                                {% else %}
                                                    {% if sortie.etat.value ==  "Activité en cours" %}
                                                        <a class="btn btn-outline-secondary" href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>
                                                    {% endif %}
                                                    {% if sortie.etat.value ==  "Cloturée" %}
                                                        <a class="btn btn-outline-secondary" href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>
                                                    {% endif %}
                                                    {% if sortie.etat.value ==  "Ouverte" %}
                                                        {% if app.user in sortie.participants %}
                                                            <a class="btn btn-outline-secondary"href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>
                                                            <a class="btn btn-outline-secondary" href="{{ path('sorties_unsubscribe', {'id': sortie.id}) }}" role="button">Se désister</a>
                                                        {% else %}
                                                            <a class="btn btn-outline-secondary" href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>

                                                            {% if sortie.participants|length < sortie.nbInscriptionMax and sortie.dateLimiteInscription|date("U") > "now"|date("U") %}
                                                                <a class="btn btn-outline-secondary" href="{{ path('sorties_subscribe', {'id': sortie.id}) }}" role="button">S'inscrire</a>
                                                            {% endif %}
                                                        {% endif %}

                                                    {% endif %}
                                                    {% if sortie.etat.value ==  "Annulée"   %}
                                                        <a class="btn btn-outline-secondary" href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>
                                                    {% endif %}
                                                    {% if sortie.etat.value ==  "Passée"  %}
                                                        <a class="btn btn-outline-secondary" href="{{ path('sorties_show', {'id': sortie.id}) }}" role="button">Afficher</a>
                                                    {% endif %}

                                                {% endif %}
                                            {% else %}
                                                Pas d'utilisateur connectées
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <p> Pas de sorties prévues</p>
            {% endif %}

        </div>

    </div>

    <div name="create" class="mt-3">
        <div class="container">
            <a id="reset-filters" class="btn btn-outline-secondary" href="{{ url('sorties_create') }}">Créer une sortie</a>
        </div>
    </div>

    {% block javascripts %}
        {{ parent() }}
        <script src="{{ asset('js/sorties.js') }}" defer></script>
    {% endblock %}
{% endblock %}

